<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:Blackjack.ViewModels"
             xmlns:converters="clr-namespace:Blackjack.Converters"
             xmlns:ic="clr-namespace:FluentIcons.Maui;assembly=FluentIcons.Maui"
             x:Class="Blackjack.Views.GameTablePage"
             x:DataType="viewmodels:GameTableViewModel"
             Title="{Binding Title}"
             Shell.NavBarIsVisible="False"
             BackgroundColor="#0A4F2C">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:CardToImageConverter x:Key="CardToImageConverter"/>
            <converters:CardFaceConverter x:Key="CardFaceConverter"/>
            <converters:BoolToOpacityConverter x:Key="BoolToOpacityConverter"/>
            <converters:InverseBoolConverter x:Key="InverseBoolConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid>
        <!-- Background: Classic Casino Green Table -->
        <Grid>
            <!-- Base layer: Dark green foundation -->
            <BoxView BackgroundColor="#0A3A28"/>

            <!-- Primary gradient layer: Rich casino green with texture simulation -->
            <BoxView>
                <BoxView.Background>
                    <RadialGradientBrush Center="0.5,0.4"
                                         Radius="1.2">
                        <GradientStop Offset="0.0"
                                      Color="#1A6B4A"/>
                        <GradientStop Offset="0.3"
                                      Color="#0F5438"/>
                        <GradientStop Offset="0.5"
                                      Color="#0C4A32"/>
                        <GradientStop Offset="0.7"
                                      Color="#0A3F2B"/>
                        <GradientStop Offset="0.9"
                                      Color="#073022"/>
                        <GradientStop Offset="1.0"
                                      Color="#05241A"/>
                    </RadialGradientBrush>
                </BoxView.Background>
            </BoxView>
        </Grid>

        <!-- Main Game Layout - Proportional sizing for responsive design -->
        <Grid RowDefinitions="35*,25*,25*,15*"
              RowSpacing="3">

            <!-- Row 0: Top Game Area (Dealer and Active Hand) -->
            <Grid Grid.Row="0"
                  ColumnDefinitions="*,*"
                  ColumnSpacing="3"
                  Margin="3"
                  x:Name="TopGameArea">

                <!-- Dealer Area (Left side during player turns, expands to full width during dealer turn) -->
                <Border x:Name="DealerAreaBorder"
                        Grid.Column="0"
                        BackgroundColor="#1A000000"
                        Padding="4"
                        StrokeThickness="2"
                        Stroke="#D4AF37">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="10"/>
                    </Border.StrokeShape>

                    <Grid>
                        <VerticalStackLayout Spacing="3">
                            <Label Text="Dealer"
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="#D4AF37"
                                   HorizontalOptions="Center"/>

                            <!-- Dealer Cards with ScrollView for overflow handling -->
                            <ScrollView x:Name="DealerCardsScrollView"
                                        Orientation="Horizontal"
                                        HorizontalScrollBarVisibility="Never">
                                <HorizontalStackLayout x:Name="DealerCardsContainer"
                                                       HorizontalOptions="Center"
                                                       Spacing="-35"/>
                            </ScrollView>
                        </VerticalStackLayout>

                        <!-- Cards Remaining Indicator (upper right corner) -->
                        <Border BackgroundColor="#40000000"
                                Padding="6,3"
                                HorizontalOptions="End"
                                VerticalOptions="Start"
                                Margin="0,0,2,0">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="4"/>
                            </Border.StrokeShape>
                            <VerticalStackLayout Spacing="1">
                                <HorizontalStackLayout Spacing="3"
                                                       HorizontalOptions="End">
                                    <Label Text="{Binding CardsRemaining}"
                                           FontSize="10"
                                           FontAttributes="Bold"
                                           TextColor="#D4AF37"
                                           VerticalOptions="Center"/>
                                    <Label Text="remaining"
                                           FontSize="8"
                                           TextColor="#80FFFFFF"
                                           VerticalOptions="Center"/>
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Spacing="3"
                                                       HorizontalOptions="End">
                                    <Label Text="{Binding CardsUntilReshuffle}"
                                           FontSize="10"
                                           FontAttributes="Bold"
                                           TextColor="#D4AF37"
                                           VerticalOptions="Center"/>
                                    <Label Text="to shuffle"
                                           FontSize="8"
                                           TextColor="#80FFFFFF"
                                           VerticalOptions="Center"/>
                                </HorizontalStackLayout>
                            </VerticalStackLayout>
                        </Border>
                    </Grid>
                </Border>

                <!-- Active Hand Display (Right side during player turns, hidden during dealer turn) -->
                <Border Grid.Column="1"
                        x:Name="ActiveHandAreaBorder"
                        BackgroundColor="#1A000000"
                        Padding="4"
                        StrokeThickness="2"
                        Stroke="#10B981">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="10"/>
                    </Border.StrokeShape>

                    <Grid x:Name="ActiveHandArea"
                          VerticalOptions="FillAndExpand"
                          HorizontalOptions="FillAndExpand">
                        <!-- This will be populated in code-behind with the active/viewed player's hand -->

                        <!-- Return to Active Button (shown when viewing non-active player) -->
                        <Button Text="â† Return to Active"
                                x:Name="ReturnToActiveButton"
                                HorizontalOptions="End"
                                VerticalOptions="Start"
                                BackgroundColor="#F59E0B"
                                TextColor="White"
                                FontAttributes="Bold"
                                FontSize="10"
                                Padding="6,4"
                                CornerRadius="4"
                                IsVisible="False"
                                Margin="0,2"/>
                    </Grid>
                </Border>
            </Grid>

            <!-- Row 1: Player Summary Strip (7 seats) -->
            <Grid Grid.Row="1"
                  x:Name="PlayerSummaryStrip"
                  ColumnDefinitions="*,*,*,*,*,*,*"
                  ColumnSpacing="3"
                  Margin="3,0"
                  Padding="2"/>

            <!-- Row 2: All Controls in One Row -->
            <Border Grid.Row="2"
                    BackgroundColor="#2A000000"
                    Padding="4"
                    Margin="3"
                    StrokeThickness="2"
                    Stroke="#D4AF37">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="10"/>
                </Border.StrokeShape>

                <!-- Container for both betting and action controls -->
                <Grid>
                    <!-- Betting Controls -->
                    <Grid ColumnDefinitions="Auto,Auto,*"
                          IsVisible="{Binding IsBetting}">
                        <!-- Left: Chip Selection (Horizontal) -->
                        <HorizontalStackLayout Grid.Column="0"
                                               Spacing="3"
                                               VerticalOptions="Center"
                                               HorizontalOptions="Start"
                                               Margin="0,0,10,0">
                            <!-- $1 Chip -->
                            <Image Source="chip_1.png"
                                   WidthRequest="35"
                                   HeightRequest="35"
                                   Aspect="AspectFit">
                                <Image.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding AddChipCommand}"
                                                          CommandParameter="1"/>
                                </Image.GestureRecognizers>
                            </Image>

                            <!-- $5 Chip -->
                            <Image Source="chip_5.png"
                                   WidthRequest="35"
                                   HeightRequest="35"
                                   Aspect="AspectFit">
                                <Image.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding AddChipCommand}"
                                                          CommandParameter="5"/>
                                </Image.GestureRecognizers>
                            </Image>

                            <!-- $25 Chip -->
                            <Image Source="chip_25.png"
                                   WidthRequest="35"
                                   HeightRequest="35"
                                   Aspect="AspectFit">
                                <Image.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding AddChipCommand}"
                                                          CommandParameter="25"/>
                                </Image.GestureRecognizers>
                            </Image>

                            <!-- $100 Chip -->
                            <Image Source="chip_100.png"
                                   WidthRequest="35"
                                   HeightRequest="35"
                                   Aspect="AspectFit">
                                <Image.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding AddChipCommand}"
                                                          CommandParameter="100"/>
                                </Image.GestureRecognizers>
                            </Image>

                            <!-- $500 Chip -->
                            <Image Source="chip_500.png"
                                   WidthRequest="35"
                                   HeightRequest="35"
                                   Aspect="AspectFit">
                                <Image.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding AddChipCommand}"
                                                          CommandParameter="500"/>
                                </Image.GestureRecognizers>
                            </Image>
                        </HorizontalStackLayout>

                        <!-- Center: Bet Display and Clear/Deal -->
                        <VerticalStackLayout Grid.Column="1"
                                             Spacing="3"
                                             HorizontalOptions="Center"
                                             VerticalOptions="Center"
                                             Margin="0,0,10,0">
                            <Label Text="{Binding CurrentBet, StringFormat='Bet: ${0:N0}'}"
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="White"
                                   HorizontalOptions="Center"/>
                            <HorizontalStackLayout Spacing="4"
                                                   HorizontalOptions="Center">
                                <Button Text="Clear"
                                        Command="{Binding ClearBetCommand}"
                                        BackgroundColor="#EF4444"
                                        TextColor="White"
                                        FontSize="10"
                                        FontAttributes="Bold"
                                        CornerRadius="4"
                                        Padding="6,4"/>
                                <Button Text="Deal"
                                        Command="{Binding ConfirmBetCommand}"
                                        IsEnabled="{Binding CanConfirmBet}"
                                        BackgroundColor="#10B981"
                                        TextColor="White"
                                        FontSize="10"
                                        FontAttributes="Bold"
                                        CornerRadius="4"
                                        Padding="6,4"
                                        Opacity="{Binding CanConfirmBet, Converter={StaticResource BoolToOpacityConverter}}"/>
                            </HorizontalStackLayout>
                        </VerticalStackLayout>
                    </Grid>

                    <!-- Action Buttons (shown when not betting) -->
                    <Grid ColumnDefinitions="*,*,*,*,*,*"
                          ColumnSpacing="3"
                          HorizontalOptions="Fill"
                          IsVisible="{Binding IsBetting, Converter={StaticResource InverseBoolConverter}}">

                        <!-- Hit Button -->
                        <Border Grid.Column="0"
                                BackgroundColor="#3B82F6"
                                StrokeThickness="0"
                                Padding="5,4"
                                Opacity="{Binding CanHit, Converter={StaticResource BoolToOpacityConverter}}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="6"/>
                            </Border.StrokeShape>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding HitCommand}"/>
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="2"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center">
                                <ic:FluentIcon Icon="ArrowDownload"
                                               IconVariant="Filled"
                                               FontSize="14"
                                               ForegroundColor="White"/>
                                <Label Text="Hit"
                                       FontSize="10"
                                       FontAttributes="Bold"
                                       TextColor="White"
                                       VerticalOptions="Center"/>
                            </HorizontalStackLayout>
                        </Border>

                        <!-- Stand Button -->
                        <Border Grid.Column="1"
                                BackgroundColor="#EF4444"
                                StrokeThickness="0"
                                Padding="5,4"
                                Opacity="{Binding CanStand, Converter={StaticResource BoolToOpacityConverter}}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="6"/>
                            </Border.StrokeShape>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding StandCommand}"/>
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="2"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center">
                                <ic:FluentIcon Icon="HandRight"
                                               IconVariant="Filled"
                                               FontSize="14"
                                               ForegroundColor="White"/>
                                <Label Text="Stand"
                                       FontSize="10"
                                       FontAttributes="Bold"
                                       TextColor="White"
                                       VerticalOptions="Center"/>
                            </HorizontalStackLayout>
                        </Border>

                        <!-- Double Button -->
                        <Border Grid.Column="2"
                                BackgroundColor="#F59E0B"
                                StrokeThickness="0"
                                Padding="5,4"
                                Opacity="{Binding CanDouble, Converter={StaticResource BoolToOpacityConverter}}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="6"/>
                            </Border.StrokeShape>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding DoubleDownCommand}"/>
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="2"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center">
                                <ic:FluentIcon Icon="ChevronDoubleDown"
                                               IconVariant="Filled"
                                               FontSize="14"
                                               ForegroundColor="White"/>
                                <Label Text="Dbl"
                                       FontSize="10"
                                       FontAttributes="Bold"
                                       TextColor="White"
                                       VerticalOptions="Center"/>
                            </HorizontalStackLayout>
                        </Border>

                        <!-- Split Button -->
                        <Border Grid.Column="3"
                                BackgroundColor="#8B5CF6"
                                StrokeThickness="0"
                                Padding="5,4"
                                Opacity="{Binding CanSplit, Converter={StaticResource BoolToOpacityConverter}}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="6"/>
                            </Border.StrokeShape>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding SplitCommand}"/>
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="2"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center">
                                <ic:FluentIcon Icon="SplitVertical"
                                               IconVariant="Filled"
                                               FontSize="14"
                                               ForegroundColor="White"/>
                                <Label Text="Split"
                                       FontSize="10"
                                       FontAttributes="Bold"
                                       TextColor="White"
                                       VerticalOptions="Center"/>
                            </HorizontalStackLayout>
                        </Border>

                        <!-- Insurance Button -->
                        <Border Grid.Column="4"
                                BackgroundColor="#22B14C"
                                StrokeThickness="0"
                                Padding="5,4"
                                Opacity="{Binding CanInsure, Converter={StaticResource BoolToOpacityConverter}}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="6"/>
                            </Border.StrokeShape>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding InsuranceCommand}"/>
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="2"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center">
                                <ic:FluentIcon Icon="Shield"
                                               IconVariant="Filled"
                                               FontSize="14"
                                               ForegroundColor="White"/>
                                <Label Text="Ins"
                                       FontSize="10"
                                       FontAttributes="Bold"
                                       TextColor="White"
                                       VerticalOptions="Center"/>
                            </HorizontalStackLayout>
                        </Border>

                        <!-- Even Money Button -->
                        <Border Grid.Column="5"
                                BackgroundColor="#FFD700"
                                StrokeThickness="0"
                                Padding="5,4"
                                Opacity="{Binding CanEvenMoney, Converter={StaticResource BoolToOpacityConverter}}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="6"/>
                            </Border.StrokeShape>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding EvenMoneyCommand}"/>
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="2"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center">
                                <ic:FluentIcon Icon="Money"
                                               IconVariant="Filled"
                                               FontSize="14"
                                               ForegroundColor="#1C1C1C"/>
                                <Label Text="Even"
                                       FontSize="10"
                                       FontAttributes="Bold"
                                       TextColor="#1C1C1C"
                                       VerticalOptions="Center"/>
                            </HorizontalStackLayout>
                        </Border>
                    </Grid>
                </Grid>
            </Border>

            <!-- Row 3: Bottom Status Bar -->
            <Border Grid.Row="3"
                    BackgroundColor="#1A000000"
                    Padding="4"
                    StrokeThickness="0">
                <Grid ColumnDefinitions="Auto,*,Auto">

                    <!-- Bankroll Display -->
                    <Border Grid.Column="0"
                            BackgroundColor="#2A10B981"
                            Padding="4"
                            StrokeThickness="1"
                            Stroke="#4010B981">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="6"/>
                        </Border.StrokeShape>
                        <HorizontalStackLayout Spacing="4">
                            <ic:FluentIcon Icon="Money"
                                           IconVariant="Filled"
                                           FontSize="14"
                                           ForegroundColor="#10B981"/>
                            <Label Text="Bankroll"
                                   FontSize="8"
                                   TextColor="#80FFFFFF"
                                   VerticalOptions="Center"/>
                            <Label Text="{Binding PlayerBankroll, StringFormat='${0:N0}'}"
                                   FontSize="12"
                                   FontAttributes="Bold"
                                   TextColor="White"
                                   VerticalOptions="Center"/>
                        </HorizontalStackLayout>
                    </Border>

                    <!-- Game Message -->
                    <Label Grid.Column="1"
                           Text="{Binding GameMessage}"
                           FontSize="10"
                           FontAttributes="Italic"
                           TextColor="#D4AF37"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"/>

                    <!-- Menu Button -->
                    <Border Grid.Column="2"
                            BackgroundColor="#2A64748B"
                            Padding="4"
                            HorizontalOptions="End">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="6"/>
                        </Border.StrokeShape>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding GoToMenuCommand}"/>
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="3">
                            <ic:FluentIcon Icon="Home"
                                           IconVariant="Regular"
                                           FontSize="14"
                                           ForegroundColor="White"/>
                            <Label Text="Menu"
                                   FontSize="10"
                                   FontAttributes="Bold"
                                   TextColor="White"
                                   VerticalOptions="Center"/>
                        </HorizontalStackLayout>
                    </Border>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</ContentPage>
